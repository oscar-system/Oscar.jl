@testset "Orthogonal groups of ZZ-lattices" begin
  N1 = root_lattice(:A, 2)
  N2 = rescale(N1, 4)
  N,_ = direct_sum(N1,N2)
  @test order(orthogonal_group(N))==144

  L = integer_lattice(; gram=QQ[4 0 0 0 0; 0 16 4 10 8; 0 4 2 3 2; 0 10 3 10 5; 0 8 2 5 34])
  G = orthogonal_group(L)
  @test order(G)==32
  @test order(Oscar._isometry_group_via_decomposition(L, _howell=true)[1]) == 32
  @test order(Oscar._isometry_group_via_decomposition(L, _howell=false)[1]) == 32
  L = integer_lattice(; gram=QQ[4 0 0 0 0; 0 16 4 10 8; 0 4 2 3 2; 0 10 3 10 5; 0 8 2 5 34]) # avoid caching
  @test order(isometry_group(L, algorithm = :decomposition, depth = 1, bacher_depth = 0)) == 32

  gram = ZZ[2 1 -1 -1 -1 1 1 -1 0 0 0 0 0 0 0 0; 1 2 -1 -1 -1 1 1 -1 0 0 0 0 0 0 0 0; -1 -1 2 0 1 0 -1 1 0 0 0 0 0 0 0 0; -1 -1 0 2 1 -1 0 0 0 0 0 0 0 0 0 0; -1 -1 1 1 2 0 -1 0 0 0 0 0 0 0 0 0; 1 1 0 -1 0 2 0 -1 0 0 0 0 0 0 0 0; 1 1 -1 0 -1 0 2 -1 0 0 0 0 0 0 0 0; -1 -1 1 0 0 -1 -1 2 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 0 2 1 1 0 1 1 1 0; 0 0 0 0 0 0 0 0 1 2 1 0 1 1 0 0; 0 0 0 0 0 0 0 0 1 1 2 0 0 0 1 0; 0 0 0 0 0 0 0 0 0 0 0 2 1 0 -1 0; 0 0 0 0 0 0 0 0 1 1 0 1 4 1 0 1; 0 0 0 0 0 0 0 0 1 1 0 0 1 4 0 0; 0 0 0 0 0 0 0 0 1 0 1 -1 0 0 8 1; 0 0 0 0 0 0 0 0 0 0 0 0 1 0 1 18]
  L = integer_lattice(; gram)
  @test order(orthogonal_group(L; algorithm = :decomposition)) == 267544166400

  H = hyperbolic_plane_lattice()
  G = orthogonal_group(H)
  @test order(G) == 4
  
  L = integer_lattice(gram=ZZ[4 1 1; 1 -2 0; 1 0 -2;])
  v = QQ[1 0 0;]
  G = stabilizer_in_orthogonal_group(L, v)
  @test order(G)==2
  @test all(v*matrix(g)==v for g in gens(G))

  for i in 2:5
    Ai = root_lattice(:A, i)
    S = symmetric_group(i+1)
    A = alternating_group(i+1)
    T = isodd(i) ? S : direct_product(A, cyclic_group(2))
    O_st, _ = stable_orthogonal_group(Ai)
    @test is_isomorphic(O_st, S)

    O_sp, _ = special_orthogonal_group(Ai)
    @test is_isomorphic(O_sp, T)

    O_spst, _ = Oscar._special_stable_orthogonal_group(Ai)
    @test is_isomorphic(O_spst, A)
  end
  
  # Examples which are slow / impossible in Hecke
  
  # shortest vector sublattice is primitive but not of full rank 
  # few shortest vectors many of length 4
  L1 = integer_lattice(gram=ZZ[2 1 -1 1 -1 -1 0 0 0 0 0 0 0 0 0 1; 1 2 -1 1 -1 0 0 0 0 0 0 0 0 0 0 1; -1 -1 2 0 1 0 0 0 0 0 0 0 0 0 0 -1; 1 1 0 2 -1 0 0 0 0 0 0 0 0 0 0 0; -1 -1 1 -1 2 0 0 0 0 0 0 0 0 0 0 0; -1 0 0 0 0 2 0 0 0 0 0 0 0 0 0 -1; 0 0 0 0 0 0 2 1 -1 1 -1 -1 -2 -1 -2 -1; 0 0 0 0 0 0 1 2 -1 1 -1 -1 -2 -1 -2 -1; 0 0 0 0 0 0 -1 -1 2 0 0 0 2 0 2 1; 0 0 0 0 0 0 1 1 0 2 -1 -1 -1 -1 -1 0; 0 0 0 0 0 0 -1 -1 0 -1 2 1 1 1 2 1; 0 0 0 0 0 0 -1 -1 0 -1 1 2 1 1 1 1; 0 0 0 0 0 0 -2 -2 2 -1 1 1 4 1 3 2; 0 0 0 0 0 0 -1 -1 0 -1 1 1 1 2 0 0; 0 0 0 0 0 0 -2 -2 2 -1 2 1 3 0 6 3; 1 1 -1 0 0 -1 -1 -1 1 0 1 1 2 0 3 4])
  # some unimodular matrix
  T = hnf_with_transform(ZZ.(gram_matrix(L1)))[2]
  L1p = lattice_in_same_ambient_space(L1, T*basis_matrix(L1))
  G1 = orthogonal_group(L1)
  @test order(G1) == 42807066624000
  b,F = is_isometric_with_isometry(L1, L1p)
  @test b 
  @test F*gram_matrix(L1p)*transpose(F) == gram_matrix(L1)
  
  # A lattice in direct sum which needs to be decomposed E8+E8+[50]
  L2 = integer_lattice(gram=ZZ[-2 -1 -1 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; -1 -2 -1 0 1 -1 0 0 0 0 0 0 0 0 0 0 0; -1 -1 -2 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -2 -1 0 -1 1 0 0 0 0 0 0 0 0 0; 1 1 1 -1 -2 1 -1 1 0 0 0 0 0 0 0 0 0; -1 -1 -1 0 1 -2 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -1 -1 1 -2 1 0 0 0 0 0 0 0 0 0; -1 0 -1 1 1 -1 1 -2 0 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 0 -2 -1 -1 1 1 -1 1 -1 0; 0 0 0 0 0 0 0 0 -1 -2 -1 0 1 -1 0 0 0; 0 0 0 0 0 0 0 0 -1 -1 -2 1 1 -1 1 -1 0; 0 0 0 0 0 0 0 0 1 0 1 -2 -1 0 -1 1 0; 0 0 0 0 0 0 0 0 1 1 1 -1 -2 1 -1 1 0; 0 0 0 0 0 0 0 0 -1 -1 -1 0 1 -2 1 -1 0; 0 0 0 0 0 0 0 0 1 0 1 -1 -1 1 -2 1 0; 0 0 0 0 0 0 0 0 -1 0 -1 1 1 -1 1 -2 0; 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 -50])
  # some unimodular matrix
  T = hnf_with_transform(ZZ.(gram_matrix(L2)))[2]
  L2p = lattice_in_same_ambient_space(L2, T*basis_matrix(L2))
  G2 = orthogonal_group(L2)
  @test order(G2) == 696729600^2*2*2
  b,F = is_isometric_with_isometry(L2, L2p)
  @test b 
  @test F*gram_matrix(L2p)*transpose(F) == gram_matrix(L2)
  
  @test !is_isometric_with_isometry(L1,L2)[1]

  orders = ZZRingElem[1941728542064640000, 288947699712000, 1941728542064640000, 67421129932800, 192631799808000, 14383174385664000, 1941728542064640000, 8090535591936000, 1941728542064640000, 1941728542064640000, 128421199872000, 8090535591936000, 1941728542064640000, 1941728542064640000, 898948399104000, 234101145600, 58525286400, 33710564966400, 59929893273600, 4045267795968000, 601974374400, 14383174385664000, 144473849856000, 1941728542064640000]

  LL =   [integer_lattice(gram=ZZ[-2 -1 -1 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; -1 -2 -1 0 1 -1 0 0 0 0 0 0 0 0 0 0 0; -1 -1 -2 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -2 -1 0 -1 1 0 0 0 0 0 0 0 0 0; 1 1 1 -1 -2 1 -1 1 0 0 0 0 0 0 0 0 0; -1 -1 -1 0 1 -2 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -1 -1 1 -2 1 0 0 0 0 0 0 0 0 0; -1 0 -1 1 1 -1 1 -2 0 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 0 -2 -1 -1 1 1 -1 1 -1 0; 0 0 0 0 0 0 0 0 -1 -2 -1 0 1 -1 0 0 0; 0 0 0 0 0 0 0 0 -1 -1 -2 1 1 -1 1 -1 0; 0 0 0 0 0 0 0 0 1 0 1 -2 -1 0 -1 1 0; 0 0 0 0 0 0 0 0 1 1 1 -1 -2 1 -1 1 0; 0 0 0 0 0 0 0 0 -1 -1 -1 0 1 -2 1 -1 0; 0 0 0 0 0 0 0 0 1 0 1 -1 -1 1 -2 1 0; 0 0 0 0 0 0 0 0 -1 0 -1 1 1 -1 1 -2 0; 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 -50]),
 integer_lattice(gram=ZZ[-2 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; 0 -2 -1 1 -1 -1 -1 0 0 0 0 0 0 0 0 0 1; 0 -1 -2 0 -1 -1 0 0 0 0 0 0 0 0 0 0 0; 0 1 0 -2 1 1 1 0 0 0 0 0 0 0 0 0 -1; 0 -1 -1 1 -2 -1 0 0 0 0 0 0 0 0 0 0 0; 0 -1 -1 1 -1 -2 0 0 0 0 0 0 0 0 0 0 0; 0 -1 0 1 0 0 -2 0 0 0 0 0 0 0 0 0 1; 0 0 0 0 0 0 0 -2 0 0 0 0 0 0 0 0 -1; 0 0 0 0 0 0 0 0 -2 -1 -1 1 1 -1 1 -1 0; 0 0 0 0 0 0 0 0 -1 -2 -1 0 1 -1 0 0 0; 0 0 0 0 0 0 0 0 -1 -1 -2 1 1 -1 1 -1 0; 0 0 0 0 0 0 0 0 1 0 1 -2 -1 0 -1 1 0; 0 0 0 0 0 0 0 0 1 1 1 -1 -2 1 -1 1 0; 0 0 0 0 0 0 0 0 -1 -1 -1 0 1 -2 1 -1 0; 0 0 0 0 0 0 0 0 1 0 1 -1 -1 1 -2 1 0; 0 0 0 0 0 0 0 0 -1 0 -1 1 1 -1 1 -2 0; 0 1 0 -1 0 0 1 -1 0 0 0 0 0 0 0 0 -6]),
 integer_lattice(gram=ZZ[-2 -1 -1 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; -1 -2 -1 0 1 -1 0 0 0 0 0 0 0 0 0 0 0; -1 -1 -2 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -2 -1 0 -1 1 0 0 0 0 0 0 0 0 0; 1 1 1 -1 -2 1 -1 1 0 0 0 0 0 0 0 0 0; -1 -1 -1 0 1 -2 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -1 -1 1 -2 1 0 0 0 0 0 0 0 0 0; -1 0 -1 1 1 -1 1 -2 0 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 0 -2 -1 -1 1 1 -1 1 -1 0; 0 0 0 0 0 0 0 0 -1 -2 -1 0 1 -1 0 0 0; 0 0 0 0 0 0 0 0 -1 -1 -2 1 1 -1 1 -1 0; 0 0 0 0 0 0 0 0 1 0 1 -2 -1 0 -1 1 0; 0 0 0 0 0 0 0 0 1 1 1 -1 -2 1 -1 1 0; 0 0 0 0 0 0 0 0 -1 -1 -1 0 1 -2 1 -1 0; 0 0 0 0 0 0 0 0 1 0 1 -1 -1 1 -2 1 0; 0 0 0 0 0 0 0 0 -1 0 -1 1 1 -1 1 -2 0; 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 -54]),
 integer_lattice(gram=ZZ[-2 1 -1 -1 1 1 1 0 0 0 0 0 0 0 1 -1 0; 1 -2 0 1 0 0 -1 0 0 0 0 0 0 0 -1 1 0; -1 0 -2 -1 1 1 1 0 0 0 0 0 0 0 1 -1 0; -1 1 -1 -2 1 0 1 0 0 0 0 0 0 0 1 -1 0; 1 0 1 1 -2 -1 -1 0 0 0 0 0 0 0 -1 1 0; 1 0 1 0 -1 -2 -1 0 0 0 0 0 0 0 -1 1 0; 1 -1 1 1 -1 -1 -2 0 0 0 0 0 0 0 -1 1 0; 0 0 0 0 0 0 0 -2 -1 -1 -1 1 -1 1 1 0 0; 0 0 0 0 0 0 0 -1 -2 -1 0 1 -1 1 0 0 0; 0 0 0 0 0 0 0 -1 -1 -2 -1 1 -1 1 1 0 0; 0 0 0 0 0 0 0 -1 0 -1 -2 1 0 0 1 0 0; 0 0 0 0 0 0 0 1 1 1 1 -2 1 -1 -1 0 0; 0 0 0 0 0 0 0 -1 -1 -1 0 1 -2 1 1 0 0; 0 0 0 0 0 0 0 1 1 1 0 -1 1 -2 -1 0 0; 1 -1 1 1 -1 -1 -1 1 0 1 1 -1 1 -1 -4 2 0; -1 1 -1 -1 1 1 1 0 0 0 0 0 0 0 2 -4 0; 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 -6]),
 integer_lattice(gram=ZZ[-2 -1 -1 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; -1 -2 -1 0 1 -1 0 0 0 0 0 0 0 0 0 0 0; -1 -1 -2 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -2 -1 0 -1 1 0 0 0 0 0 0 0 0 0; 1 1 1 -1 -2 1 -1 1 0 0 0 0 0 0 0 0 0; -1 -1 -1 0 1 -2 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -1 -1 1 -2 1 0 0 0 0 0 0 0 0 0; -1 0 -1 1 1 -1 1 -2 0 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 0 -2 -1 -1 1 0 0 0 0 0; 0 0 0 0 0 0 0 0 -1 -2 -1 1 0 0 0 0 0; 0 0 0 0 0 0 0 0 -1 -1 -2 0 0 0 0 0 0; 0 0 0 0 0 0 0 0 1 1 0 -2 0 0 0 0 0; 0 0 0 0 0 0 0 0 0 0 0 0 -2 1 -1 1 1; 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 0 -1 -1; 0 0 0 0 0 0 0 0 0 0 0 0 -1 0 -2 0 1; 0 0 0 0 0 0 0 0 0 0 0 0 1 -1 0 -2 0; 0 0 0 0 0 0 0 0 0 0 0 0 1 -1 1 0 -4]),
 integer_lattice(gram=ZZ[-2 -1 -1 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; -1 -2 -1 0 1 -1 0 0 0 0 0 0 0 0 0 0 0; -1 -1 -2 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -2 -1 0 -1 1 0 0 0 0 0 0 0 0 0; 1 1 1 -1 -2 1 -1 1 0 0 0 0 0 0 0 0 0; -1 -1 -1 0 1 -2 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -1 -1 1 -2 1 0 0 0 0 0 0 0 0 0; -1 0 -1 1 1 -1 1 -2 0 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 0 -2 -1 1 1 -1 1 -1 -1 0; 0 0 0 0 0 0 0 0 -1 -2 1 0 -1 1 0 0 0; 0 0 0 0 0 0 0 0 1 1 -2 -1 1 -1 0 0 0; 0 0 0 0 0 0 0 0 1 0 -1 -2 1 -1 0 0 0; 0 0 0 0 0 0 0 0 -1 -1 1 1 -2 1 0 0 0; 0 0 0 0 0 0 0 0 1 1 -1 -1 1 -2 0 0 0; 0 0 0 0 0 0 0 0 -1 0 0 0 0 0 -2 -1 0; 0 0 0 0 0 0 0 0 -1 0 0 0 0 0 -1 -2 0; 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 -14]),
 integer_lattice(gram=ZZ[-2 -1 -1 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; -1 -2 -1 0 1 -1 0 0 0 0 0 0 0 0 0 0 0; -1 -1 -2 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -2 -1 0 -1 1 0 0 0 0 0 0 0 0 0; 1 1 1 -1 -2 1 -1 1 0 0 0 0 0 0 0 0 0; -1 -1 -1 0 1 -2 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -1 -1 1 -2 1 0 0 0 0 0 0 0 0 0; -1 0 -1 1 1 -1 1 -2 0 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 0 -2 -1 -1 1 1 -1 1 -1 0; 0 0 0 0 0 0 0 0 -1 -2 -1 0 1 -1 0 0 0; 0 0 0 0 0 0 0 0 -1 -1 -2 1 1 -1 1 -1 0; 0 0 0 0 0 0 0 0 1 0 1 -2 -1 0 -1 1 0; 0 0 0 0 0 0 0 0 1 1 1 -1 -2 1 -1 1 0; 0 0 0 0 0 0 0 0 -1 -1 -1 0 1 -2 1 -1 0; 0 0 0 0 0 0 0 0 1 0 1 -1 -1 1 -2 1 0; 0 0 0 0 0 0 0 0 -1 0 -1 1 1 -1 1 -2 0; 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 -56]),
 integer_lattice(gram=ZZ[-2 -1 -1 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; -1 -2 -1 0 1 -1 0 0 0 0 0 0 0 0 0 0 0; -1 -1 -2 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -2 -1 0 -1 1 0 0 0 0 0 0 0 0 0; 1 1 1 -1 -2 1 -1 1 0 0 0 0 0 0 0 0 0; -1 -1 -1 0 1 -2 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -1 -1 1 -2 1 0 0 0 0 0 0 0 0 0; -1 0 -1 1 1 -1 1 -2 0 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 0 -2 -1 1 -1 1 1 1 0 -1; 0 0 0 0 0 0 0 0 -1 -2 1 -1 1 0 0 0 -1; 0 0 0 0 0 0 0 0 1 1 -2 0 0 0 0 0 1; 0 0 0 0 0 0 0 0 -1 -1 0 -2 1 0 0 0 0; 0 0 0 0 0 0 0 0 1 1 0 1 -2 0 0 0 0; 0 0 0 0 0 0 0 0 1 0 0 0 0 -2 -1 0 1; 0 0 0 0 0 0 0 0 1 0 0 0 0 -1 -2 0 1; 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 -2 1; 0 0 0 0 0 0 0 0 -1 -1 1 0 0 1 1 1 -16]),
 integer_lattice(gram=ZZ[-2 -1 -1 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; -1 -2 -1 0 1 -1 0 0 0 0 0 0 0 0 0 0 0; -1 -1 -2 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -2 -1 0 -1 1 0 0 0 0 0 0 0 0 0; 1 1 1 -1 -2 1 -1 1 0 0 0 0 0 0 0 0 0; -1 -1 -1 0 1 -2 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -1 -1 1 -2 1 0 0 0 0 0 0 0 0 0; -1 0 -1 1 1 -1 1 -2 0 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 0 -2 -1 -1 1 1 -1 1 -1 0; 0 0 0 0 0 0 0 0 -1 -2 -1 0 1 -1 0 0 0; 0 0 0 0 0 0 0 0 -1 -1 -2 1 1 -1 1 -1 0; 0 0 0 0 0 0 0 0 1 0 1 -2 -1 0 -1 1 0; 0 0 0 0 0 0 0 0 1 1 1 -1 -2 1 -1 1 0; 0 0 0 0 0 0 0 0 -1 -1 -1 0 1 -2 1 -1 0; 0 0 0 0 0 0 0 0 1 0 1 -1 -1 1 -2 1 0; 0 0 0 0 0 0 0 0 -1 0 -1 1 1 -1 1 -2 0; 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 -58]),
 integer_lattice(gram=ZZ[-2 -1 -1 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; -1 -2 -1 0 1 -1 0 0 0 0 0 0 0 0 0 0 0; -1 -1 -2 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -2 -1 0 -1 1 0 0 0 0 0 0 0 0 0; 1 1 1 -1 -2 1 -1 1 0 0 0 0 0 0 0 0 0; -1 -1 -1 0 1 -2 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -1 -1 1 -2 1 0 0 0 0 0 0 0 0 0; -1 0 -1 1 1 -1 1 -2 0 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 0 -2 -1 -1 1 1 -1 1 -1 0; 0 0 0 0 0 0 0 0 -1 -2 -1 0 1 -1 0 0 0; 0 0 0 0 0 0 0 0 -1 -1 -2 1 1 -1 1 -1 0; 0 0 0 0 0 0 0 0 1 0 1 -2 -1 0 -1 1 0; 0 0 0 0 0 0 0 0 1 1 1 -1 -2 1 -1 1 0; 0 0 0 0 0 0 0 0 -1 -1 -1 0 1 -2 1 -1 0; 0 0 0 0 0 0 0 0 1 0 1 -1 -1 1 -2 1 0; 0 0 0 0 0 0 0 0 -1 0 -1 1 1 -1 1 -2 0; 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 -60]),
 integer_lattice(gram=ZZ[-2 -1 -1 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; -1 -2 -1 0 1 -1 0 0 0 0 0 0 0 0 0 0 0; -1 -1 -2 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -2 -1 0 -1 1 0 0 0 0 0 0 0 0 0; 1 1 1 -1 -2 1 -1 1 0 0 0 0 0 0 0 0 0; -1 -1 -1 0 1 -2 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -1 -1 1 -2 1 0 0 0 0 0 0 0 0 0; -1 0 -1 1 1 -1 1 -2 0 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 0 -2 1 -1 -1 0 0 0 0 -1; 0 0 0 0 0 0 0 0 1 -2 1 1 0 0 0 0 1; 0 0 0 0 0 0 0 0 -1 1 -2 0 0 0 0 0 0; 0 0 0 0 0 0 0 0 -1 1 0 -2 0 0 0 0 -1; 0 0 0 0 0 0 0 0 0 0 0 0 -2 1 -1 1 0; 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 -1 0; 0 0 0 0 0 0 0 0 0 0 0 0 -1 1 -2 1 0; 0 0 0 0 0 0 0 0 0 0 0 0 1 -1 1 -2 0; 0 0 0 0 0 0 0 0 -1 1 0 -1 0 0 0 0 -4]),
 integer_lattice(gram=ZZ[-2 -1 -1 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; -1 -2 -1 0 1 -1 0 0 0 0 0 0 0 0 0 0 0; -1 -1 -2 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -2 -1 0 -1 1 0 0 0 0 0 0 0 0 0; 1 1 1 -1 -2 1 -1 1 0 0 0 0 0 0 0 0 0; -1 -1 -1 0 1 -2 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -1 -1 1 -2 1 0 0 0 0 0 0 0 0 0; -1 0 -1 1 1 -1 1 -2 0 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 0 -2 -1 1 -1 1 -1 -1 0 -1; 0 0 0 0 0 0 0 0 -1 -2 0 0 1 -1 -1 0 0; 0 0 0 0 0 0 0 0 1 0 -2 0 -1 0 0 0 1; 0 0 0 0 0 0 0 0 -1 0 0 -2 0 -1 -1 0 -1; 0 0 0 0 0 0 0 0 1 1 -1 0 -2 0 0 0 0; 0 0 0 0 0 0 0 0 -1 -1 0 -1 0 -2 -1 0 -1; 0 0 0 0 0 0 0 0 -1 -1 0 -1 0 -1 -2 0 -1; 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 -6 3; 0 0 0 0 0 0 0 0 -1 0 1 -1 0 -1 -1 3 -8]),
 integer_lattice(gram=ZZ[-2 -1 -1 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; -1 -2 -1 0 1 -1 0 0 0 0 0 0 0 0 0 0 0; -1 -1 -2 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -2 -1 0 -1 1 0 0 0 0 0 0 0 0 0; 1 1 1 -1 -2 1 -1 1 0 0 0 0 0 0 0 0 0; -1 -1 -1 0 1 -2 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -1 -1 1 -2 1 0 0 0 0 0 0 0 0 0; -1 0 -1 1 1 -1 1 -2 0 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 0 -2 -1 1 1 1 -1 1 1 0; 0 0 0 0 0 0 0 0 -1 -2 1 1 1 -1 0 1 0; 0 0 0 0 0 0 0 0 1 1 -2 0 -1 1 -1 0 0; 0 0 0 0 0 0 0 0 1 1 0 -2 -1 0 0 -1 0; 0 0 0 0 0 0 0 0 1 1 -1 -1 -2 0 0 0 0; 0 0 0 0 0 0 0 0 -1 -1 1 0 0 -2 1 1 0; 0 0 0 0 0 0 0 0 1 0 -1 0 0 1 -2 0 0; 0 0 0 0 0 0 0 0 1 1 0 -1 0 1 0 -2 0; 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 -62]),
 integer_lattice(gram=ZZ[-2 -1 -1 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; -1 -2 -1 0 1 -1 0 0 0 0 0 0 0 0 0 0 0; -1 -1 -2 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -2 -1 0 -1 1 0 0 0 0 0 0 0 0 0; 1 1 1 -1 -2 1 -1 1 0 0 0 0 0 0 0 0 0; -1 -1 -1 0 1 -2 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -1 -1 1 -2 1 0 0 0 0 0 0 0 0 0; -1 0 -1 1 1 -1 1 -2 0 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 0 -2 -1 -1 1 1 -1 1 -1 0; 0 0 0 0 0 0 0 0 -1 -2 -1 0 1 -1 0 0 0; 0 0 0 0 0 0 0 0 -1 -1 -2 1 1 -1 1 -1 0; 0 0 0 0 0 0 0 0 1 0 1 -2 -1 0 -1 1 0; 0 0 0 0 0 0 0 0 1 1 1 -1 -2 1 -1 1 0; 0 0 0 0 0 0 0 0 -1 -1 -1 0 1 -2 1 -1 0; 0 0 0 0 0 0 0 0 1 0 1 -1 -1 1 -2 1 0; 0 0 0 0 0 0 0 0 -1 0 -1 1 1 -1 1 -2 0; 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 -70]),
 integer_lattice(gram=ZZ[-2 -1 -1 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; -1 -2 -1 0 1 -1 0 0 0 0 0 0 0 0 0 0 0; -1 -1 -2 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -2 -1 0 -1 1 0 0 0 0 0 0 0 0 0; 1 1 1 -1 -2 1 -1 1 0 0 0 0 0 0 0 0 0; -1 -1 -1 0 1 -2 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -1 -1 1 -2 1 0 0 0 0 0 0 0 0 0; -1 0 -1 1 1 -1 1 -2 0 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 0 -2 -1 -1 1 1 -1 -1 1 1; 0 0 0 0 0 0 0 0 -1 -2 -1 0 1 -1 -1 0 0; 0 0 0 0 0 0 0 0 -1 -1 -2 1 1 -1 -1 1 1; 0 0 0 0 0 0 0 0 1 0 1 -2 -1 1 1 -1 -1; 0 0 0 0 0 0 0 0 1 1 1 -1 -2 1 1 0 0; 0 0 0 0 0 0 0 0 -1 -1 -1 1 1 -2 -1 1 1; 0 0 0 0 0 0 0 0 -1 -1 -1 1 1 -1 -2 0 0; 0 0 0 0 0 0 0 0 1 0 1 -1 0 1 0 -6 -1; 0 0 0 0 0 0 0 0 1 0 1 -1 0 1 0 -1 -6]),
 integer_lattice(gram=ZZ[-2 -1 -1 1 1 1 1 0 0 0 0 0 1 0 0 -1 0; -1 -2 -1 1 1 1 0 0 0 0 0 0 1 0 0 -1 0; -1 -1 -2 0 1 1 1 0 0 0 0 0 0 0 0 0 0; 1 1 0 -2 0 -1 0 0 0 0 0 0 -1 0 0 1 0; 1 1 1 0 -2 -1 -1 0 0 0 0 0 0 0 0 0 0; 1 1 1 -1 -1 -2 -1 0 0 0 0 0 0 0 0 0 0; 1 0 1 0 -1 -1 -2 0 0 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 -2 1 -1 -1 1 -1 1 1 0 1; 0 0 0 0 0 0 0 1 -2 1 1 -1 0 -1 -1 0 -1; 0 0 0 0 0 0 0 -1 1 -2 -1 1 -1 1 1 0 0; 0 0 0 0 0 0 0 -1 1 -1 -2 1 -1 1 1 0 0; 0 0 0 0 0 0 0 1 -1 1 1 -2 1 -1 -1 0 0; 1 1 0 -1 0 0 0 -1 0 -1 -1 1 -4 1 1 1 0; 0 0 0 0 0 0 0 1 -1 1 1 -1 1 -2 -1 0 0; 0 0 0 0 0 0 0 1 -1 1 1 -1 1 -1 -2 0 0; -1 -1 0 1 0 0 0 0 0 0 0 0 1 0 0 -4 1; 0 0 0 0 0 0 0 1 -1 0 0 0 0 0 0 1 -4]),
 integer_lattice(gram=ZZ[-2 -1 -1 1 1 1 1 0 0 0 0 0 1 1 -1 0 0; -1 -2 -1 1 1 1 0 0 0 0 0 0 1 1 -1 0 0; -1 -1 -2 0 1 1 1 0 0 0 0 0 0 0 0 0 0; 1 1 0 -2 0 -1 0 0 0 0 0 0 -1 -1 1 0 0; 1 1 1 0 -2 -1 -1 0 0 0 0 0 0 0 0 0 0; 1 1 1 -1 -1 -2 -1 0 0 0 0 0 0 0 0 0 0; 1 0 1 0 -1 -1 -2 0 0 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 -2 1 -1 1 -1 1 -1 1 1 -1; 0 0 0 0 0 0 0 1 -2 1 -1 1 -1 0 -1 0 0; 0 0 0 0 0 0 0 -1 1 -2 1 -1 0 -1 1 1 -1; 0 0 0 0 0 0 0 1 -1 1 -2 1 0 1 -1 -1 1; 0 0 0 0 0 0 0 -1 1 -1 1 -2 1 -1 1 0 -1; 1 1 0 -1 0 0 0 1 -1 0 0 1 -4 -1 1 0 0; 1 1 0 -1 0 0 0 -1 0 -1 1 -1 -1 -4 2 1 -1; -1 -1 0 1 0 0 0 1 -1 1 -1 1 1 2 -4 0 1; 0 0 0 0 0 0 0 1 0 1 -1 0 0 1 0 -4 0; 0 0 0 0 0 0 0 -1 0 -1 1 -1 0 -1 1 0 -4]),
 integer_lattice(gram=ZZ[-2 1 -1 -1 1 1 1 0 0 0 0 0 0 0 1 1 1; 1 -2 0 1 0 0 -1 0 0 0 0 0 0 0 -1 -1 -1; -1 0 -2 -1 1 1 1 0 0 0 0 0 0 0 1 1 1; -1 1 -1 -2 1 0 1 0 0 0 0 0 0 0 1 1 1; 1 0 1 1 -2 -1 -1 0 0 0 0 0 0 0 -1 -1 -1; 1 0 1 0 -1 -2 -1 0 0 0 0 0 0 0 -1 -1 -1; 1 -1 1 1 -1 -1 -2 0 0 0 0 0 0 0 -1 -1 -1; 0 0 0 0 0 0 0 -2 -1 -1 1 -1 1 -1 1 0 0; 0 0 0 0 0 0 0 -1 -2 0 1 -1 0 0 1 0 0; 0 0 0 0 0 0 0 -1 0 -2 1 -1 1 -1 0 0 0; 0 0 0 0 0 0 0 1 1 1 -2 1 0 0 0 0 0; 0 0 0 0 0 0 0 -1 -1 -1 1 -2 0 0 0 0 0; 0 0 0 0 0 0 0 1 0 1 0 0 -2 1 -1 0 0; 0 0 0 0 0 0 0 -1 0 -1 0 0 1 -2 1 0 0; 1 -1 1 1 -1 -1 -1 1 1 0 0 0 -1 1 -4 -1 -2; 1 -1 1 1 -1 -1 -1 0 0 0 0 0 0 0 -1 -4 -2; 1 -1 1 1 -1 -1 -1 0 0 0 0 0 0 0 -2 -2 -10]),
 integer_lattice(gram=ZZ[-2 -1 -1 1 1 1 1 0 0 0 0 0 0 0 0 1 0; -1 -2 -1 1 1 1 0 0 0 0 0 0 0 0 0 0 0; -1 -1 -2 0 1 1 1 0 0 0 0 0 0 0 0 1 0; 1 1 0 -2 0 -1 0 0 0 0 0 0 0 0 0 0 0; 1 1 1 0 -2 -1 -1 0 0 0 0 0 0 0 0 -1 0; 1 1 1 -1 -1 -2 -1 0 0 0 0 0 0 0 0 -1 0; 1 0 1 0 -1 -1 -2 0 0 0 0 0 0 0 0 -1 0; 0 0 0 0 0 0 0 -2 -1 -1 -1 -1 1 1 -1 0 0; 0 0 0 0 0 0 0 -1 -2 -1 -1 -1 0 0 0 0 0; 0 0 0 0 0 0 0 -1 -1 -2 0 -1 0 0 0 0 0; 0 0 0 0 0 0 0 -1 -1 0 -2 -1 0 0 0 0 0; 0 0 0 0 0 0 0 -1 -1 -1 -1 -2 0 0 0 0 0; 0 0 0 0 0 0 0 1 0 0 0 0 -2 -1 1 0 0; 0 0 0 0 0 0 0 1 0 0 0 0 -1 -2 1 0 0; 0 0 0 0 0 0 0 -1 0 0 0 0 1 1 -2 0 0; 1 0 1 0 -1 -1 -1 0 0 0 0 0 0 0 0 -4 1; 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -4]),
 integer_lattice(gram=ZZ[-2 -1 -1 1 1 1 1 0 0 0 0 0 0 0 0 -1 1; -1 -2 -1 1 1 1 0 0 0 0 0 0 0 0 0 -1 0; -1 -1 -2 0 1 1 1 0 0 0 0 0 0 0 0 0 0; 1 1 0 -2 0 -1 0 0 0 0 0 0 0 0 0 1 0; 1 1 1 0 -2 -1 -1 0 0 0 0 0 0 0 0 0 0; 1 1 1 -1 -1 -2 -1 0 0 0 0 0 0 0 0 0 0; 1 0 1 0 -1 -1 -2 0 0 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 -2 -1 -1 1 1 -1 1 -1 0 0; 0 0 0 0 0 0 0 -1 -2 -1 0 1 -1 0 0 0 0; 0 0 0 0 0 0 0 -1 -1 -2 1 1 -1 1 -1 0 0; 0 0 0 0 0 0 0 1 0 1 -2 -1 0 -1 1 0 0; 0 0 0 0 0 0 0 1 1 1 -1 -2 1 -1 1 0 0; 0 0 0 0 0 0 0 -1 -1 -1 0 1 -2 1 -1 0 0; 0 0 0 0 0 0 0 1 0 1 -1 -1 1 -2 1 0 0; 0 0 0 0 0 0 0 -1 0 -1 1 1 -1 1 -2 0 0; -1 -1 0 1 0 0 0 0 0 0 0 0 0 0 0 -6 2; 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 2 -10]),
 integer_lattice(gram=ZZ[-2 -1 -1 1 1 1 1 0 0 0 0 0 0 1 0 0 0; -1 -2 -1 1 1 1 0 0 0 0 0 0 0 1 0 0 0; -1 -1 -2 0 1 1 1 0 0 0 0 0 0 0 0 0 0; 1 1 0 -2 0 -1 0 0 0 0 0 0 0 -1 0 0 0; 1 1 1 0 -2 -1 -1 0 0 0 0 0 0 0 0 0 0; 1 1 1 -1 -1 -2 -1 0 0 0 0 0 0 0 0 0 0; 1 0 1 0 -1 -1 -2 0 0 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 -2 1 -1 -1 -1 1 -1 0 1 -1; 0 0 0 0 0 0 0 1 -2 1 1 0 -1 1 0 -1 1; 0 0 0 0 0 0 0 -1 1 -2 0 0 1 0 0 0 0; 0 0 0 0 0 0 0 -1 1 0 -2 -1 1 -1 0 1 -1; 0 0 0 0 0 0 0 -1 0 0 -1 -2 0 0 0 0 0; 0 0 0 0 0 0 0 1 -1 1 1 0 -2 1 0 -1 1; 1 1 0 -1 0 0 0 -1 1 0 -1 0 1 -4 0 1 -1; 0 0 0 0 0 0 0 0 0 0 0 0 0 0 -2 1 0; 0 0 0 0 0 0 0 1 -1 0 1 0 -1 1 1 -4 1; 0 0 0 0 0 0 0 -1 1 0 -1 0 1 -1 0 1 -4]),
 integer_lattice(gram=ZZ[-2 -1 -1 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; -1 -2 -1 0 1 -1 0 0 0 0 0 0 0 0 0 0 0; -1 -1 -2 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -2 -1 0 -1 1 0 0 0 0 0 0 0 0 0; 1 1 1 -1 -2 1 -1 1 0 0 0 0 0 0 0 0 0; -1 -1 -1 0 1 -2 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -1 -1 1 -2 1 0 0 0 0 0 0 0 0 0; -1 0 -1 1 1 -1 1 -2 0 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 0 -2 -1 1 -1 -1 1 1 -1 0; 0 0 0 0 0 0 0 0 -1 -2 1 -1 -1 0 0 0 0; 0 0 0 0 0 0 0 0 1 1 -2 0 1 0 0 0 0; 0 0 0 0 0 0 0 0 -1 -1 0 -2 -1 0 0 0 0; 0 0 0 0 0 0 0 0 -1 -1 1 -1 -2 0 0 0 0; 0 0 0 0 0 0 0 0 1 0 0 0 0 -2 -1 1 0; 0 0 0 0 0 0 0 0 1 0 0 0 0 -1 -2 1 0; 0 0 0 0 0 0 0 0 -1 0 0 0 0 1 1 -2 0; 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 -18]),
 integer_lattice(gram=ZZ[-2 -1 -1 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; -1 -2 -1 0 1 -1 0 0 0 0 0 0 0 0 0 0 0; -1 -1 -2 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -2 -1 0 -1 1 0 0 0 0 0 0 0 0 0; 1 1 1 -1 -2 1 -1 1 0 0 0 0 0 0 0 0 0; -1 -1 -1 0 1 -2 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -1 -1 1 -2 1 0 0 0 0 0 0 0 0 0; -1 0 -1 1 1 -1 1 -2 0 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 0 -2 1 -1 1 -1 1 0 1 0; 0 0 0 0 0 0 0 0 1 -2 1 -1 0 0 0 -1 0; 0 0 0 0 0 0 0 0 -1 1 -2 0 -1 0 0 1 0; 0 0 0 0 0 0 0 0 1 -1 0 -2 0 0 0 0 0; 0 0 0 0 0 0 0 0 -1 0 -1 0 -2 0 0 0 0; 0 0 0 0 0 0 0 0 1 0 0 0 0 -2 0 -1 0; 0 0 0 0 0 0 0 0 0 0 0 0 0 0 -2 1 0; 0 0 0 0 0 0 0 0 1 -1 1 0 0 -1 1 -4 -1; 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 -1 -6]),
 integer_lattice(gram=ZZ[-2 -1 -1 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; -1 -2 -1 0 1 -1 0 0 0 0 0 0 0 0 0 0 0; -1 -1 -2 1 1 -1 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -2 -1 0 -1 1 0 0 0 0 0 0 0 0 0; 1 1 1 -1 -2 1 -1 1 0 0 0 0 0 0 0 0 0; -1 -1 -1 0 1 -2 1 -1 0 0 0 0 0 0 0 0 0; 1 0 1 -1 -1 1 -2 1 0 0 0 0 0 0 0 0 0; -1 0 -1 1 1 -1 1 -2 0 0 0 0 0 0 0 0 0; 0 0 0 0 0 0 0 0 -2 -1 -1 1 1 -1 1 -1 0; 0 0 0 0 0 0 0 0 -1 -2 -1 0 1 -1 0 0 0; 0 0 0 0 0 0 0 0 -1 -1 -2 1 1 -1 1 -1 0; 0 0 0 0 0 0 0 0 1 0 1 -2 -1 0 -1 1 0; 0 0 0 0 0 0 0 0 1 1 1 -1 -2 1 -1 1 0; 0 0 0 0 0 0 0 0 -1 -1 -1 0 1 -2 1 -1 0; 0 0 0 0 0 0 0 0 1 0 1 -1 -1 1 -2 1 0; 0 0 0 0 0 0 0 0 -1 0 -1 1 1 -1 1 -2 0; 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 -72])]
  
  for (L,ord) in zip(LL[5:10], orders[5:10])  # take a smaller sample for fast test
    @test order(orthogonal_group(L))==ord
    Lp = lattice_in_same_ambient_space(L, T*basis_matrix(L))
    b, F = is_isometric_with_isometry(L, Lp)
    @test b 
    @test F*gram_matrix(Lp)*transpose(F) == gram_matrix(L)
  end
end
