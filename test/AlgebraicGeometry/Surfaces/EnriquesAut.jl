@testset "Enriques surface automorphism groups" begin
  B = matrix(QQ, 26, 26 ,[1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1]);
  G = matrix(QQ, 26, 26 ,[4, 4, 6, 10, 9, 8, 6, 5, 3, 1, 1, -1, 1, -1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, -1, -2, 4, 0, 4, 7, 6, 3, 4, 1, 2, -1, -2, 1, -1, 1, -1, -1, -2, 0, 0, 0, 0, 0, -2, -2, 0, 1, 6, 4, 6, 13, 11, 10, 7, 6, 4, 0, -1, 0, 0, -2, 0, -1, -1, 1, 1, 1, -1, -2, 1, 0, -2, -2, 10, 7, 13, 20, 18, 15, 12, 9, 6, 3, 0, -1, 1, -1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, -2, -1, 9, 6, 11, 18, 14, 13, 9, 8, 5, 2, -1, 1, -1, -1, 0, -1, 0, 1, 1, 1, -1, -2, 0, 0, 0, 0, 8, 3, 10, 15, 13, 6, 8, 3, 2, -1, -3, 0, 0, 2, -1, -2, -4, -1, -2, -2, 0, 1, -2, -2, 0, 1, 6, 4, 7, 12, 9, 8, 4, 5, 2, 0, -2, 1, -1, -1, 0, -1, -1, 0, 1, 1, -2, -2, 0, 0, 0, 0, 5, 1, 6, 9, 8, 3, 5, 0, 1, -1, -2, 0, 0, 2, -1, -1, -3, -1, -1, -2, 1, 1, -2, -2, 0, 1, 3, 2, 4, 6, 5, 2, 2, 1, -2, -1, -2, -1, 1, 1, 0, -1, -3, -2, -2, -2, 0, 0, 0, 0, 0, 0, 1, -1, 0, 3, 2, -1, 0, -1, -1, -6, -3, 1, -1, 0, -3, -5, -4, 0, 0, 0, -2, -1, -2, -2, 0, -1, 1, -2, -1, 0, -1, -3, -2, -2, -2, -3, -6, 2, -2, 1, 0, -2, -4, 0, 0, 0, -2, -2, -2, -2, 0, 2, -1, 1, 0, -1, 1, 0, 1, 0, -1, 1, 2, -4, 3, 0, 1, 2, 0, -2, -2, -2, 2, 2, 2, 2, -2, -2, 1, -1, 0, 1, -1, 0, -1, 0, 1, -1, -2, 3, -4, 0, -1, -2, 0, 2, 2, 2, -2, -2, -2, -2, 2, 2, -1, 1, -2, -1, -1, 2, -1, 2, 1, 0, 1, 0, 0, -4, 1, 0, 2, 2, 2, 2, -2, -2, 2, 2, -2, -2, 0, -1, 0, 1, 0, -1, 0, -1, 0, -3, 0, 1, -1, 1, -4, -4, -1, 0, 0, 0, 0, 0, -2, -2, 2, 0, 0, -1, -1, 1, -1, -2, -1, -1, -1, -5, -2, 2, -2, 0, -4, -8, -2, 2, 0, 0, -2, -2, -2, -2, 2, 0, 0, -2, -1, 0, 0, -4, -1, -3, -3, -4, -4, 0, 0, 2, -1, -2, -6, -2, -2, -2, 0, 0, -2, -2, 0, 0, 0, 0, 1, 0, 1, -1, 0, -1, -2, 0, 0, -2, 2, 2, 0, 2, -2, -4, -2, -2, 2, 2, 0, 0, 0, 0, 0, 0, 1, 0, 1, -2, 1, -1, -2, 0, 0, -2, 2, 2, 0, 0, -2, -2, -4, -2, 2, 2, 0, 0, 0, 0, 0, 0, 1, 0, 1, -2, 1, -2, -2, 0, 0, -2, 2, 2, 0, 0, -2, -2, -2, -4, 2, 2, 0, 0, 0, 0, 0, 0, -1, 0, -1, 0, -2, 1, 0, -2, -2, 2, -2, -2, 0, -2, 0, 2, 2, 2, -4, -2, 0, 0, 0, 0, 0, 0, -2, 0, -2, 1, -2, 1, 0, -1, -2, 2, -2, -2, 0, -2, 0, 2, 2, 2, -2, -4, 0, 0, 0, 0, 1, -2, 1, 1, 0, -2, 0, -2, 0, -2, -2, 2, -2, 2, -2, -2, -2, 0, 0, 0, 0, 0, -4, -2, 2, 2, 1, -2, 0, 1, 0, -2, 0, -2, 0, -2, -2, 2, -2, 2, -2, -2, -2, 0, 0, 0, 0, 0, -2, -4, 2, 2, -1, 0, -2, -2, 0, 0, 0, 0, 0, 0, 0, -2, 2, -2, 2, 2, 0, 0, 0, 0, 0, 0, 2, 2, -4, -2, -2, 1, -2, -1, 0, 1, 0, 1, 0, -1, 2, -2, 2, -2, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, -2, -4]);
  L26 = integer_lattice(B, gram = G);

  V = ambient_space(L26)
  B = matrix(QQ, 19, 26 ,[-4, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1, 2, 0, -3, 2, 0, 0, 0, -1, 1, 0, 0, 1, -1, 0, 0, 0, 0, -1, 1, 0, 0, 0, -1, 1, 0, 0, 0, 0, 2, -4, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, -1, 1, 0, 2, 2, 0, 2, -4, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -2, 0, -1, 1, -2, 0, 0, 0, 2, -3, 1, -1, 1, -1, 0, -1, 1, 0, 0, 0, 0, 1, 1, 0, -1, 1, 3, -1, -1, -2, -1, 0, 0, 0, 0, 0, -1, 2, -1, 1, 0, 1, -1, 0, 0, 0, 0, -1, -2, 0, 1, -2, -2, 1, 1, 1, 1, 0, 0, 0, 0, 1, -1, 0, -1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, -1, 1, 1, 1, 0, 0, -1, 0, 0, 0, 1, -1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1, -2, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, -2, 0, 0, 0, 0, 0, -1, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, -2, 0, -1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, -1, 0, 1, 1, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1, -1, -1, 0, 2, 0, 0, 0, -1, 0, 0, 0, 1, 0, 1, -1, 0, 0, 0, 0, -1, 0, -1, 0, -1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, -1, 1, 0, 0, 1, -1, 0, 0, 0, 0, -1, 1, 0, 0, 0, 0, -1, -1, -1, 1, 2, -1, 0, 0, -2, 2, 0, 1, 0, 0, 1, -1, 0, 0, -1, 1, -1, 1, -3, -1, -2, 0, -1, -1, -1, 0, 0, 0, 0, 0, 1, -2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1, 1, 1, 0, -1, 1, 1, 1, 0, 1, 0, 0, 1, -2, 0, 1, 0, 1, 0, 1, -1, 0, 0, -1, 1, -1, 0, -2, 0, -2, -1, 0, 0, 0, 0, 1, 0, 1, -2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1, 0, 0, 1, -1, 0, 1, -2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 1, -1, 1, 0, -1, 0, 1, 0, 0, 0, 1, -1, 0, 0, 0, 0, -1, 0, -1, 1, -1, -1, 1, 0, 0, 0]);
  SX = lattice(V, B)
  
  B = matrix(QQ, 10, 26 ,[-4, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1, 2, 0, -3, 2, 0, 0, 0, -1, 1, 0, 0, 1, -1, 0, 0, 0, 0, -1, 1, 0, 0, 0, -1, 1, 0, 0, 0, 0, 2, -4, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, -1, 1, 0, 2, 2, 0, 2, -4, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -2, 0, -1, 1, -2, 0, 0, 0, 2, -3, 1, -1, 1, -1, 0, -1, 1, 0, 0, 0, 0, 1, 1, 0, -1, 1, 3, -1, -1, -2, -1, 0, 0, 0, 0, 0, -1, 2, -1, 1, 0, 1, -1, 0, 0, 0, 0, -1, -2, 0, 1, -2, -2, 1, 1, 1, 1, 0, 0, 0, 0, 1, -1, 0, -1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, -1, 1, 1, 1, 0, 0, -1, 0, 0, 0, 1, -1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1, -2, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, -2, 0, 0, 0, 0, 0, -1, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, -2, 0, -1, 1, 1, 1, 1, 0, 0, 0, 0]);
  SY = lattice(V, B)
  
  weyl = ZZ[2   -3   2   2   -5   2   1   1   0   0   2   -2   -1   -1   -3   2   -3   2   -4   -1   -3   0   1   0   -2   1]
  
  Y = Oscar.EnriquesBorcherdsCtx(SY, SX, L26, weyl)
  autY, chambersY, ratsY = borcherds_method(Y)
  @test length(chambersY)==1
  C = only(chambersY)
  @test length(rays(C))==6457
  @test length(Oscar.isotropic_rays(C)) == 247
  @test length(walls(C)) == 40
  @test length(ratsY) == 2
  @test mass(Y) == 1//60
  @test Oscar.root_invariant(Y)[2][1] == [(:A, 4), (:A, 5)]
  @test length(Oscar.splitting_roots_mod2(Y)) == 25
  @test rays(C) == Oscar.initial_rays(Y)
  @test walls(C) == Oscar.initial_walls(Y)
  @test length(Oscar.initial_automorphisms(Y)) == 1440
  
  @test length(enriques_surface_automorphism_group(SY,SX; ample=ZZ[22 16 30 46 42 32 24 18 14 5])[2])==1
  
  v = Oscar.isotropic_rays(C)[1]
  L = lattice(rational_span(SY))
  Oscar.frame_lattice(L,QQ.(v))
  @test Oscar.chamber_invariants(Y)[1] == 1440
  
  fbar = discriminant_group(Y.SY)(1//2*(v*basis_matrix(Y.SY))[1,:])
  @test reducible_fibers(Y, fbar) == ([(:A, 1),  (:A, 3), (:A, 3)],[])

  @test sum([(i[1]) for i in Oscar.isomorphism_classes_elliptic_fibrations(Y)])==527
    
  # square 2
  h2 = ZZ.(QQ[0 1 0 0 0 0 0 0 0 0]*2*inv(gram_matrix(SY)))
  # square 4
  h4a = ZZ.(QQ[0 0 1 0 0 0 0 0 0 0]*2*inv(gram_matrix(SY)))
  h4b = ZZ.(QQ[1 1 0 0 0 0 0 0 0 0]*2*inv(gram_matrix(SY)))
  @test isomorphism_classes_polarizations(Y, ZZ.(h2))[1] == 505920
end
