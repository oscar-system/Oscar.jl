# this can be run from the command line with:
# > julia etc/format_code.jl
#
using Pkg
Pkg.activate(; temp=true)
Pkg.add(name="JuliaFormatter", version="1")

using JuliaFormatter


# ------------------------------------------------------------------------------
# Disclaimer:
#
# To ensure consistent formatting, we employ the package `JuliaFormatter.jl`. The
# `.JuliaFormatter.toml` file in the repository defines the desired formatting style.
#
# To format your files, first add the `JuliaFormatter.jl` package in Julia. You
# can then format individual files via:
#
# using JuliaFormatter
# format_file("path/to/file/file.jl")
#
# To format an entire folder (recursively), use `format("path/to/folder")`. Note
# that both `format` and `format_file` return a `Bool`; you may need to repeat the
# command until it returns `true`. This is a known shortcoming of the current
# `JuliaFormatter` package.
#
# Ultimately, we aim to use the workflow provided by https://github.com/julia-actions/julia-format.
# Instead of performing a single large reformatting of the entire OSCAR code base, we are extending
# coverage incrementally. A custom CI job ensures that already-compliant parts of OSCAR
# remain consistent with the defined style. Whenever the scope of this CI is extended
# - for example, to verify that code in a new experimental module meets our formatting
# requirements - special care must be taken. Details on how to extend the scope of this
# CI mechanism are described below. All other formatting changes can be handled like regular commits.
#
# Extending the JuliaFormatter CI
# 1) Create a commit that contains only the formatting changes automatically
#    generated by JuliaFormatter - no other modifications.
# 2) Create a second commit with the following updates:
#    a) Add the commit hash from step 1 to `.git-blame-ignore-revs`, so that
#       `git blame` ignores these purely stylistic edits.
#    b) Add the folder that should from now on be checked by the CI to the
#       `files_and_dirs_to_be_formatted` list below.
# ------------------------------------------------------------------------------

oscardir = joinpath(@__DIR__, "..")

files_and_dirs_to_be_formatted = [
  "src/InvariantTheory",
  "src/PolyhedralGeometry",
  "test/PolyhedralGeometry",
  "src/LieTheory",
  "test/LieTheory",
  "src/aliases.jl",
  "src/AlgebraicGeometry/ToricVarieties",
  "test/AlgebraicGeometry/ToricVarieties",
  "experimental/BasisLieHighestWeight",
  "experimental/ExperimentalTemplate",
  "experimental/ExteriorAlgebra",
  "experimental/LieAlgebras",
  "experimental/LinearQuotients",
  "experimental/FTheoryTools",
]
# a few files for one reason or another may need to be skipped
ignore = [
  "experimental/InvariantTheory/src/InvariantTheory.jl",
]

for fname in files_and_dirs_to_be_formatted
  while !format(fname; ignore)
    # invoke format until it reports no more changes, to work around
    # <https://github.com/domluna/JuliaFormatter.jl/issues/897>
  end
end
